<script>
document.querySelectorAll('.toggle-details').forEach(button => {
    button.addEventListener('click', () => {
        // Toggle details
        const parentItem = button.closest('.reference-item');
        const details = parentItem.querySelector('.reference-item-details');
        if (details.style.display === 'block') {
            details.style.display = 'none';
        } else {
            details.style.display = 'block';
        }
    });
});

// Selection checkbox logic
(function() {
    const selectAll = document.getElementById('select-all');
    const downloadBtn = document.getElementById('download-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const rowCheckboxes = () => Array.from(document.querySelectorAll('.select-row'));

    if (!selectAll || !downloadBtn || !deleteSelectedBtn) return;

    const updateDownloadButton = () => {
        const anySelected = rowCheckboxes().some(cb => cb.checked);
        downloadBtn.textContent = anySelected ? 'Download selected as BibTeX file' : 'Download all as BibTeX file';
    };

    const updateDeleteSelectedButton = () => {
        const anySelected = rowCheckboxes().some(cb => cb.checked);
        deleteSelectedBtn.disabled = !anySelected;
    };

    // Select all functionality
    selectAll.addEventListener('change', () => {
        rowCheckboxes().forEach(cb => { cb.checked = selectAll.checked; });
        updateDownloadButton();
        updateDeleteSelectedButton();
    });

    // When any row checkbox changes, update the select-all state
    document.addEventListener('change', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('select-row')) {
            const boxes = rowCheckboxes();
            const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
            const someChecked = boxes.some(cb => cb.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && someChecked;
            updateDownloadButton();
            updateDeleteSelectedButton();
        }
    });

    // Submit selected keys via POST to /download_bib
    downloadBtn.addEventListener('click', () => {
        const selectedKeys = rowCheckboxes().filter(cb => cb.checked).map(cb => cb.dataset.key);

        // Create a form and POST selected_keys (one input per key).
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/download_bib';
        // Add selected keys inputs
        selectedKeys.forEach(k => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_keys';
            input.value = k;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    });

    // Delete selected functionality
    deleteSelectedBtn.addEventListener('click', () => {
        const selectedKeys = rowCheckboxes().filter(cb => cb.checked).map(cb => cb.dataset.key);
        

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/confirm_delete_selected';
        
        selectedKeys.forEach(k => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_keys';
            input.value = k;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    });

    // initialise button on load
    updateDownloadButton();
    updateDeleteSelectedButton();
})();

// Upload file logic
document.getElementById('fileInput').addEventListener('change', async function() {
    if (!this.files[0]) return;

    const formData = new FormData();
    formData.append('file', this.files[0]);

    try {
        const response = await fetch('/upload_bib', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            // Reload the page to see the uploaded references
            window.location.reload();
        } else {
            let errorMsg = 'Upload failed.';
            try {
                const text = await response.text();
                if (text) errorMsg += ' ' + text;
            } catch (e) {
                // ignore
            }
            alert(errorMsg);
        }
    } catch (error) {
        console.error('Upload failed:', error);
        alert('Upload failed: ' + error.message);
    }
});
</script>