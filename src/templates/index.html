{% extends "layout.html" %}

{% block title %}
My references
{% endblock %}

{% block body %}

<h2 class="page-title">My references</h2>

<div class="sidebar">
    <h2 style="margin-top:0px; margin-bottom:0.3em;">Filters</h2>
    <form id="filterForm" action="/" method="get">
        <label for="choose_field">Search field</label>
        <select name="keyword_field" id="choose_field">
            <option value="any" {{ 'selected' if request.args.get('keyword_field') == 'any' else '' }}>Any</option>
            <option value="author" {{ 'selected' if request.args.get('keyword_field') == 'author' else '' }}>Author</option>
            <option value="title" {{ 'selected' if request.args.get('keyword_field') == 'title' else '' }}>Title</option>
            <option value="publisher" {{ 'selected' if request.args.get('keyword_field') == 'publisher' else '' }}>Publisher</option>
            <option value="year" {{ 'selected' if request.args.get('keyword_field') == 'year' else '' }}>Year</option>
            <option value="key" {{ 'selected' if request.args.get('keyword_field') == 'key' else '' }}>Key</option>
        </select>
        <span class="tooltip" onclick="this.classList.toggle('active')" onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); this.classList.toggle('active'); }" tabindex="0" role="button" aria-label="Year search help">i
        <span class="tooltiptext">When searching for year, you can use "&lt;" ,"&gt;" and "-" operators!
        <br> e.g., "&lt;2000", "&gt;1980", "2010-2020"
        </span>
        </span>
        <input type="text" name="keyword_value" placeholder="Enter search word" value="{{ request.args.get('keyword_value', '') }}"><br>

        <label>Select reference types</label>
        {% for ref_type in reference_types %}
            <input type="checkbox" name="reference_type[]" value="{{ ref_type.value }}" {{ 'checked' if ref_type.value in request.args.getlist('reference_type[]') else '' }}>
            {{ ref_type.display_str() }}<br>
        {% endfor %}
        <label>Select tags</label>
        {% if tags and tags|length > 0 %}
            {% for tag, count in tags %}
                <input type="checkbox" name="tag[]" value="{{ tag.name }}" {{ 'checked' if tag.name in request.args.getlist('tag[]') else '' }}>
                <span style="font-variant-caps: all-petite-caps;">{{ tag.name }}</span><br>
            {% endfor %}
        {% else %}
            <p>No tags available.</p>
        {% endif %}
        <h2 style="margin-top:0.3em; margin-bottom:0.3em;">Sort By</h2>
        <select name="sort_by">
            <option value="" {{ 'selected' if not request.args.get('sort_by') else '' }}>-- No sorting --</option>
            <option value="author" {{ 'selected' if request.args.get('sort_by') == 'author' else '' }}>Author</option>
            <option value="year" {{ 'selected' if request.args.get('sort_by') == 'year' else '' }}>Year</option>
            <option value="type" {{ 'selected' if request.args.get('sort_by') == 'type' else '' }}>Type</option>
            <option value="key" {{ 'selected' if request.args.get('sort_by') == 'key' else '' }}>Key</option>
        </select>
</form>
<form id="clearForm" action="/" method="get" style="display:inline;"></form><br>
<button type="submit" form="filterForm" class="button-green" id="btn-apply-filters">Apply</button>
<button type="submit" form="clearForm" class="button-green" id="btn-clear-filters">Clear</button>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

<div class="reference-count">
    Number of references: {{ references|length }}
</div>

<div>
    <button onclick="location.href='/new_reference'" class="button-green" style="margin-top: 15px;">
        New reference
    </button>
    <button id="download-btn" type="button" class="button-green" style="margin-top: 15px;">
        Download as BibTex-file
    </button>
    <label id="upload-btn" type="button" class="button-green" style="margin-top: 15px;">
        Upload a BibTex-file
        <input type="file" id="fileInput" hidden>
    </label>
    <button id="delete-selected-btn" type="button" class="button-red delete-selected-btn" disabled style="margin-top: 15px;">
        Delete selected
    </button>
    <button onclick="location.href='/tag_management'" id="tags-btn" type="button" class="button-edit" style="margin-top: 15px; margin-bottom: 0px;">
        Manage tags
    </button>
</div>


<div class="table-container">
    <!-- Table header -->
    <div class="reference-item table-title">
        <div>
            <input type="checkbox" id="select-all" title="Select all">
        </div>
        <div>Type</div>
        <div>Key</div>
        <div>Author</div>
        <div>Title</div>
        <div>Year</div>
        <div>Action</div>
    </div>

    <!-- Table rows -->
    {% for reference in references %}
    <div class="reference-item">
        <!-- Checkbox -->
        <div>
            <input type="checkbox" class="select-row" data-key="{{ reference.key }}" aria-label="Select {{ reference.key }}">
        </div>

        <!-- Main details -->
        <div>{{ reference.type.display_str() }}</div>
        <div>{{ reference.key }}</div>
        <div>{{ reference.content.get('author', '') }}</div>
        <div>{{ reference.content.get('title', '') }}</div>
        <div>{{ reference.content.get('year', '') }}</div>
        <div>
            <button class="toggle-details action-button">
                Details
            </button><br>
            <button onclick="location.href='/edit_reference/{{ reference.key }}'" class="button-edit action-button">
                Edit
            </button><br>
            <button onclick="location.href='/confirm_delete/{{ reference.key }}'" class="button-red action-button">
                Delete
            </button>
        </div>

        <!-- Extra details -->
        <div class="reference-item-details">
            {% if reference.tags and reference.tags|length > 0 %}
            <div class="tags-container">
                <span><b>Tags:</b></span>
                {% for tag in reference.tags %}
                <span class="tag-item">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if reference.comment.strip() != '' %}
                <span class="comment"><b>Comment:</b> {{ reference.comment }}</span>
            {% endif %}

            {# render normal datapoints first #}
            {% for datapoint, value in reference.content.items() %}
                {% if datapoint not in ['author', 'title', 'year', 'comment'] %}
                    {% set is_wide = value and value|length > 80 %}
                    {% if not is_wide %}
                        <span class="datapoint"><b>{{ datapoint | replace('_', ' ') | title }}:</b> {{ value }}</span>
                    {% endif %}
                {% endif %}
            {% endfor %}
            {# then render wide datapoints last #}
            {% for datapoint, value in reference.content.items() %}
                {% if datapoint not in ['author', 'title', 'year', 'comment'] %}
                    {% set is_wide = value and value|length > 80 %}
                    {% if is_wide %}
                        <span class="datapoint datapoint--wide"><b>{{ datapoint | replace('_', ' ') | title }}:</b> {{ value }}</span>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block scripts %}
{% include 'scripts/front_page_script.html' %}
{% endblock %}
