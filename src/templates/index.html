{% extends "layout.html" %}

{% block title %}
My references
{% endblock %}

{% block body %}

<h2 class="page-title">My references</h2>

<div class="sidebar">
    <h2>Filters:</h2>
    <form action="/" method="get">
        <label><b>Select reference types:</b></label><br>
        {% for ref_type in reference_types %}
        <input type="checkbox" name="reference_type[]" value="{{ ref_type.value }}">
        {{ ref_type.display_str() }}<br>
        {% endfor %}
    <button type="submit" class="button-green">Apply Filters</button>
</form>
<form action="/" method="get" style="display:inline;">
    <button type="submit" class="button-green">
        Clear Filters
    </button>
</form>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

<div class="reference-count">
  Number of references: {{ amount }}
</div>

<div>
    <button onclick="location.href='/new_reference'" class="button-green" style="margin-top: 15px;">
        New reference
    </button>
    <button id="download-btn" type="button" class="button-green" style="margin-top: 15px;">
        Download as BibTex-file
    </button>
</div>


<div class="table-container">
    <!-- Table header -->
    <div class="reference-item table-title">
        <div>
            <input type="checkbox" id="select-all" title="Select all">
        </div>
        <div>Type</div>
        <div>Key</div>
        <div>Author</div>
        <div>Title</div>
        <div>Year</div>
        <div>Action</div>
    </div>

    <!-- Table rows -->
    {% for reference in references %}
    <div class="reference-item">
        <!-- Checkbox -->
        <div>
            <input type="checkbox" class="select-row" data-key="{{ reference.key }}" aria-label="Select {{ reference.key }}">
        </div>

        <!-- Main details -->
        <div>{{ reference.type.display_str() }}</div>
        <div>{{ reference.key }}</div>
        <div>{{ reference.content.get('author', '') }}</div>
        <div>{{ reference.content.get('title', '') }}</div>
        <div>{{ reference.content.get('year', '') }}</div>
        <div>
            <button class="toggle-details">Details</button><br>
            <button onclick="location.href='/edit_reference/{{ reference.key }}'" class="button-edit">
                Edit
            </button><br>
            <button onclick="location.href='/confirm_delete/{{ reference.key }}'" class="button-red">
                Delete
            </button>
        </div>

        <!-- Extra details -->
        <div class="reference-item-details">
            {% if reference.comment.strip() != '' %}
                <span><b>Comment:</b> {{ reference.comment }}</span>
                <br>
            {% endif %}

            {% for datapoint, value in reference.content.items() %}
                {% if datapoint not in ['author', 'title', 'year', 'comment'] %}
                <span><b>{{ datapoint | replace('_', ' ') | title }}:</b> {{ value }}</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% block tags %}
<div class="tags-container" style="margin-top: 25px;">
    <h3>My tags with their reference counts</h3>
    {% if tags and tags|length > 0 %}
        <ul class="tag-list">
            {% for tag in tags %}
                <li class="tag-item">{{ tag.name }} <span class="tag-count">({{ tag.count }})</span></li>
            {% endfor %}
        </ul>
    {% else %}
        <div>No tags yet.</div>
    {% endif %}
</div>
{% endblock %}
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.toggle-details').forEach(button => {
    button.addEventListener('click', () => {
        // Toggle details
        const parentItem = button.closest('.reference-item');
        const details = parentItem.querySelector('.reference-item-details');
        if (details.style.display === 'block') {
            details.style.display = 'none';
        } else {
            details.style.display = 'block';
        }
    });
});

// Selection checkbox logic
(function() {
    const selectAll = document.getElementById('select-all');
    const downloadBtn = document.getElementById('download-btn');
    const rowCheckboxes = () => Array.from(document.querySelectorAll('.select-row'));

    if (!selectAll || !downloadBtn) return;

    const updateDownloadButton = () => {
        const anySelected = rowCheckboxes().some(cb => cb.checked);
        downloadBtn.textContent = anySelected ? 'Download selected as BibTeX file' : 'Download all as BibTeX file';
    };

    // Select all functionality
    selectAll.addEventListener('change', () => {
        rowCheckboxes().forEach(cb => { cb.checked = selectAll.checked; });
        updateDownloadButton();
    });

    // When any row checkbox changes, update the select-all state
    document.addEventListener('change', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('select-row')) {
            const boxes = rowCheckboxes();
            const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
            const someChecked = boxes.some(cb => cb.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && someChecked;
            updateDownloadButton();
        }
    });

    // Submit selected keys via POST to /download_bib
    downloadBtn.addEventListener('click', () => {
        const selectedKeys = rowCheckboxes().filter(cb => cb.checked).map(cb => cb.dataset.key);

        // Create a form and POST selected_keys (one input per key).
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/download_bib';
        // Add selected keys inputs
        selectedKeys.forEach(k => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_keys';
            input.value = k;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    });

    // initialise button on load
    updateDownloadButton();
})();
</script>
{% endblock %}
